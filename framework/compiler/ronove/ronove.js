#!/usr/bin/env node
(function(){var t,e=function(t,e){return function(){return t.apply(e,arguments)}},r=[].indexOf||function(t){for(var e=0,r=this.length;r>e;e++)if(e in this&&this[e]===t)return e;return-1};t=function(){function t(){this._triggerNative=e(this._triggerNative,this),this.trigger=e(this.trigger,this)}return t.prototype._events=null,t.prototype.on=function(t,e){return this._events||(this._events={}),this._events[t]||(this._events[t]=[]),r.call(this._events[t],e)>=0?void 0:this._events[t].unshift(e)},t.prototype.off=function(t,e){var r,n;if(null==t&&(t=null),null==e&&(e=null),!this._events)return void(this._events={});if(r=this._events[t]){if(e){for(;(n=r.indexOf(e))>=0;)r.splice(n,1);return this._events[t]=r}return this._events[t].length=0}},t.prototype.offAll=function(){return this._events={},!1},t.prototype.trigger=function(t,e,r){var n,i,s,o,h,a,u,p;if(null==e&&(e=null),null==r&&(r=null),Array.isArray(t))for(a=0,u=t.length;u>a;a++)n=t[a],this.trigger(t,e);else if(this._events||(this._events={}),i=this._events[t],i&&0!==i.length){if(r||(r=this),n={type:t,target:r,currentTarget:this},"object"==typeof e)for(o in e)h=e[o],n[o]||(n[o]=h);for(s=i.length,p=[];s-->0;)p.push("function"==typeof i[s]?i[s](n,e):void 0);return p}},t.prototype._triggerNative=function(t){var e,r,n;if(this._events||(this._events={}),e=this._events[t.type],e&&0!==e.length){for(r=e.length,t.targetClass=this,n=[];r-->0;)n.push("function"==typeof e[r]?e[r](t):void 0);return n}},t.prototype.hasEvent=function(t,e){var r;for(r in this._events)if(r===t&&this._events[r].indexOf(e)>-1)return!0;return!1},t}();var n,i={}.hasOwnProperty,s=function(t,e){function r(){this.constructor=t}for(var n in e)i.call(e,n)&&(t[n]=e[n]);return r.prototype=e.prototype,t.prototype=new r,t.__super__=e.prototype,t};n=function(t){function e(){this._paths=[],this._pathWatcher={}}return s(e,t),e.CHANGED="watcherChanged",e.ADDED="watcherAdded",e.REMOVED="watcherRemoved",e.prototype.pathExists=function(t){return this._pathWatcher[t]?!0:!1},e.prototype.addPath=function(t,r){var n,i,s;return null==r&&(r=!1),t=f.resolve(t),this.pathExists(t)?this._pathWatcher[t]:(s=c.watch(t,this._pathChange),s._parent=this,s._file=t,this._paths[this._paths.length]={file:t,watcher:s},this._pathWatcher[t]=s,i=c.statSync(t),i.isDirectory()?(n=this._parsePaths(t),r&&this.trigger(e.ADDED,n),n):s)},e.prototype.removeAll=function(){var t;for(t=this._paths.length;t-->0;)this._paths[t].watcher.close();return delete this._pathWatcher,this._paths.length=0,this._pathWatcher={}},e.prototype.removePath=function(t){var e,r,n;for(r=this._paths.length,e=t.replace(/(\W)/g,"\\$1"),e=new RegExp("^"+e,"g"),n=[];r-->0;)e.lastIndex=0,e.test(this._paths[r].file)?(this._paths[r].watcher.close(),this._paths.splice(r,1),this._pathWatcher[this._paths[r].file],n.push(delete this._pathWatcher[this._paths[r].file])):n.push(void 0);return n},e.prototype._parsePaths=function(t){var e,r,n,i,s,o;if(t=t.rtrim("/")+"/",o=c.statSync(t),o.isDirectory()){for(r=c.readdirSync(t),i=r.length,e=[];i-->0;)s=t+r[i],e.push(s),o=c.statSync(s),!o.isSymbolicLink()&&o.isDirectory()&&(n=this._parsePaths(s),e=[].concat(n,e));return this.addPath(t),e}},e.prototype._pathChange=function(t,r){var n,i;return n=this._parent,r=f.resolve(this._file+"/"+r),c.existsSync(r)?(n.trigger(e.CHANGED,r),i=c.statSync(r),i.isDirectory()?n.addPath(r,!0):void 0):(n.removePath(r),n.trigger(e.REMOVED,r))},e}(t);var o,h=[].slice;o=function(){function t(){}return t.COLORS={black:0,red:1,green:2,yellow:3,blue:4,magenta:5,cyan:6,white:7},t.setStyle=function(t,e){var r;return null==t&&(t="white"),null==e&&(e=null),r=[],this.COLORS[t]||(t="white"),r.push("3"+this.COLORS[t]),e&&this.COLORS[e]&&r.push("4"+this.COLORS[e]),r.push("22m"),process.stdout.write("["+r.join(";"))},t.log=function(){return console.log(value)},t.print=function(){var t;return t=1<=arguments.length?h.call(arguments,0):[],process.stdout.write(t.join(" ")),process.stdout.write("[0m")},t.println=function(){var t;return t=1<=arguments.length?h.call(arguments,0):[],process.stdout.write(t.join(" ")),process.stdout.write("[0m\n")},t._test=function(e){return process.stdout.off("data",t._test),console.log("Received",e)},t}();var a;a=function(){function t(){}return t.notify=function(t,e){return null==e&&(e=""),l("osascript -e 'display notification \""+e+'" with title "'+t+"\"'")},t}();var u,e=function(t,e){return function(){return t.apply(e,arguments)}},i={}.hasOwnProperty,s=function(t,e){function r(){this.constructor=t}for(var n in e)i.call(e,n)&&(t[n]=e[n]);return r.prototype=e.prototype,t.prototype=new r,t.__super__=e.prototype,t};u=function(t){function r(){this._listFiles=e(this._listFiles,this),this._paths=[]}return s(r,t),r.prototype.setOutputPath=function(t){return this._output=f.resolve(t)},r.prototype.addPath=function(t){return this._paths.push(t)},r.prototype.parse=function(){var t,e,r,n,i,s;if(!this._parsing){for(this._clearOutputFolder(),this._parsing=!0,e=[],r=this._paths.length,n="";r-->0;)s=f.resolve(this._paths[r]).rtrim("/")+"/",e=[].concat(e,this._listFiles("",s,r)),c.existsSync(s+"Readme.ronove")&&(n=c.readFileSync(s+"Readme.ronove",{encoding:"utf-8"}));return t=this._parseFiles(e),i={content:t},n&&(i.index=n),c.writeFileSync(this._output+"/data/content.json",JSON.stringify(i,null,"	"),{encoding:"utf8"}),this._parsing=!1}},r.prototype._clearOutputFolder=function(){return this._output?(this._copyFilesRecursive("template/",this._output),c.existsSync(this._output)||c.mkdirSync(this._output,"0777"),c.existsSync(this._output+"/data")?void 0:c.mkdirSync(this._output+"/data","0777")):void 0},r.prototype._copyFilesRecursive=function(t,e){var r,n,i,s,o,h,a;if(t=t.rtrim("/")+"/",o=c.statSync(t),o.isDirectory()){for(e=e.rtrim("/")+"/",c.existsSync(e)||c.mkdirSync(e,"0777"),n=c.readdirSync(t),s=n.length,r=[],a=[];s-->0;)i=t+n[s],h=e+n[s],o=c.statSync(i),a.push(o.isDirectory()?this._copyFilesRecursive(i,h):c.createReadStream(i).pipe(c.createWriteStream(h)));return a}},r.prototype._removeFolderRecursive=function(t){var e,r,n,i,s;if(c.existsSync(t)){if(s=c.statSync(t),!s.isDirectory())return void c.unlinkSync(t);for(t=t.rtrim("/")+"/",r=c.readdirSync(t),n=r.length,e=[];n-->0;)i=t+r[n],s=c.statSync(i),s.isDirectory()?this._removeFolderRecursive(i):c.unlinkSync(i);return c.rmdirSync(t),e}},r.prototype._listFiles=function(t,e,r){var n,i,s,o,h,a,u;if(null==e&&(e=""),null==r&&(r=0),t=t.rtrim("/")+"/",n=(e+t).rtrim("/")+"/",u=c.statSync(n),u.isDirectory()){for(s=c.readdirSync(n),h=s.length,i=[];h-->0;)a=n+s[h],/\.coffee$/.test(s[h])?i.push({file:t+s[h],path:n+s[h],index:r}):(u=c.statSync(a),!u.isSymbolicLink()&&u.isDirectory()&&(o=this._listFiles(t+s[h],e,r),i=[].concat(o,i)));return i}},r.prototype._parseFiles=function(t){var e,r,n,i,s,o,h,a,u,p,l,f,_,g,y,d,v,m,S,w,x;for(h=t.length,m=0,e=[],r=/(^[\s]*)(\#{3})([\s\S]*?)\1\2[\s]*^\1(?:class\s+([^\s]+)(?:\s+extends\s+([^\s]*))?|(\@)?([^\s]+)\s*:)/gm;h-->0;){for(s=t[h],a=!1,v={path:s.file,methods:[],statics:[],index:s.index},i=c.readFileSync(s.path,{encoding:"utf-8"}),r.lastIndex=0,o=/^(.*?)\/?([^\/]+)\.coffee/i.exec(s.file),o&&(o[1]&&o.length>0&&(v["package"]=o[1].trim("/").replace(/\//g,".")),v.classPath=(o[1]+"/"+o[2]).trim("/").replace(/\//g,"."),v.name=o[2]),x=[],w=[];d=r.exec(i);)if(n=this._parseContent(d[3],d[1]),d[4]&&d[4].length>0){if(new RegExp(d[1]+"@ignore").test(d[3])){a=!0;break}v.name=d[4],d[5]&&d[5].length>0&&(v["extends"]=d[5]),v.content=n}else{if(new RegExp(d[1]+"@ignore").test(d[3]))continue;p={name:d[7]},p.content=n,(n.name||n.title)&&(p.name=n.name||n.title),d[6]&&d[6].length>9?(x.push(p.name),v.statics.push(p)):(w.push(p.name),v.methods.push(p))}if(!a&&(d=/^class\s+(?:[^\s]+)[\s\S]*?^(\s+)[^\s]+:.*?>/m.exec(i)))for(u=d[1].replace("	","\\t").replace("\n",""),f=new RegExp("^"+u+"(@?)([^\\s_@][^\\s]*)\\s*:(.*)[-=]s*>","gm");d=f.exec(i);){if(_=[],d[3])for(g=/(?:\@)?([^\s\(\)\,\=\:]+)\s*(?:\=\s*([\'\"])?([^\s\(\)\,\=\:]+)\2)?/g;y=g.exec(d[3]);)S="  "+y[1]+": ",y[3]&&y[3].length>0&&(S+="Default value "+y[3]),_.push(S);p={name:d[2]},_.length>0&&(l=this._parseContent("@params \n"+_.join("\n"),"",!0),l.length>0&&(p.content=l)),d[1]?x.indexOf(d[2])<0&&(x.push(d[2]),v.statics.push(p)):w.indexOf(d[2])<0&&(w.push(d[2]),v.methods.push(p))}a||(e[m++]=v)}return e},r.prototype._parseContent=function(t,e,r){var n,i,s,o,h,a,u,p,l,c,f;for(null==e&&(e=""),null==r&&(r=!1),f=new RegExp(e+"@([^\\s]+)([\\s\\S]*?)(?="+e+"@|$)","g"),t=t.replace(/\\@/g,"-%%%%-"),o=[],u=0;c=f.exec(t);){for(a=c[2].replace(/\-\%\%\%\%\-/g,"@"),/\n/.test(a.trim())?(a=a.replace(/^[\s]*(?=^)/m,""),n=/^(\s*)[^\s]/.exec(a),n=n?n[1]:"",a=a.replace(new RegExp("^"+n,"mg"),"")):a=a.trim(),h={type:c[1]},l=[],i=/^(\s*)(?:('{3})|(?:(.*?):)?)([\s\S]+?)(?:\1?\2)$/gm;s=i.exec(a);)p={},s[2]&&s[2].length>0&&(p.code=!0),s[3]&&s[3].length>0&&(p.name=s[3]),p.text=s[4].replace(new RegExp("^"+e,"mg"),"").trim(),p.text.length>0&&l.push(p);h.items=l,o.push(h)}return o},r}(t);var p,l,c,f,e=function(t,e){return function(){return t.apply(e,arguments)}};String.prototype.ltrim=function(t){var e;return null==t&&(t=null),t||(t="\\s"),e=new RegExp("^"+t+"*"),e.global=!0,e.multiline=!0,this.replace(e,"")},String.prototype.rtrim=function(t){var e;return null==t&&(t=null),t||(t="\\s"),e=new RegExp(t+"*$"),e.global=!0,e.multiline=!0,this.replace(e,"")},String.prototype.trim=function(t){return null==t&&(t=null),this.ltrim(t).rtrim(t)},c=require("fs"),f=require("path"),l=require("child_process").exec,new(p=function(){function t(){this._parseFiles=e(this._parseFiles,this),this._fileChanged=e(this._fileChanged,this);var t,r,n,i,s,h,a,u,p,l;for(this.ugly=!1,s=process.argv.splice(2),h={},i={i:"input",o:"output",w:"watch"},t="params",a=0,u=s.length;u>a;a++)n=s[a],(r=/\-{1,2}([^\s]+)/.exec(n))?(t=i[r[1]]?i[r[1]]:r[1],"watch"===t&&(h[t]=!0)):(null==h[t]&&(h[t]=[]),h[t].push(n),t="params");return!(null!=(p=h.input)?p.length:void 0)>0?(o.setStyle("red"),o.println("No input folder specified. Use -i or --input parameter to specify."),o.setStyle("cyan"),void o.println("-i ./someFolder")):!(null!=(l=h.output)?l.length:void 0)>0?(o.setStyle("red"),o.println("No output folder specified. Use -o or --output parameter to specify."),o.setStyle("cyan"),void o.println("-o ./someFolder")):void this._init(h)}return t.prototype._fileChanged=function(){return clearTimeout(this._parseTimeout),this._parseTimeout=setTimeout(this._parseFiles,500)},t.prototype._parseFiles=function(){return clearTimeout(this._parseTimeout),this._coffeeParser.parse()},t.prototype._init=function(t){var e,r,i,s,o,h,a;for(this._coffeeParser=new u,h=t.input,r=0,s=h.length;s>r;r++)e=h[r],this._coffeeParser.addPath(e);if(t.output&&t.output.length>0&&this._coffeeParser.setOutputPath(t.output[0]),t.watch){for(this._watcher=new n,a=t.input,i=0,o=a.length;o>i;i++)e=a[i],this._watcher.addPath(e);this._watcher.on(n.CHANGED,this._fileChanged),this._watcher.on(n.ADDED,this._fileChanged),this._watcher.on(n.REMOVED,this._fileChanged)}return this._parseFiles()},t}())}).call(this);