<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>../../source/coffee/caim/net/API.coffee - Caim Framework</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="http://slikland.com/media/images/logo_docs.png" title="Caim Framework"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 3.3.2</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/_.html">_</a></li>
                                <li><a href="../classes/AnimationTicker.html">AnimationTicker</a></li>
                                <li><a href="../classes/API.html">API</a></li>
                                <li><a href="../classes/App.html">App</a></li>
                                <li><a href="../classes/ArrayUtils.html">ArrayUtils</a></li>
                                <li><a href="../classes/AssetLoader.html">AssetLoader</a></li>
                                <li><a href="../classes/BaseAnimation.html">BaseAnimation</a></li>
                                <li><a href="../classes/BaseDOM.html">BaseDOM</a></li>
                                <li><a href="../classes/BaseNavigationController.html">BaseNavigationController</a></li>
                                <li><a href="../classes/BaseView.html">BaseView</a></li>
                                <li><a href="../classes/Caim.html">Caim</a></li>
                                <li><a href="../classes/ColorUtils.html">ColorUtils</a></li>
                                <li><a href="../classes/ConditionsValidation.html">ConditionsValidation</a></li>
                                <li><a href="../classes/CookiesManager.html">CookiesManager</a></li>
                                <li><a href="../classes/DataStorageManager.html">DataStorageManager</a></li>
                                <li><a href="../classes/Debug.html">Debug</a></li>
                                <li><a href="../classes/DefaultNavigationController.html">DefaultNavigationController</a></li>
                                <li><a href="../classes/Detections.html">Detections</a></li>
                                <li><a href="../classes/DOMUtils.html">DOMUtils</a></li>
                                <li><a href="../classes/EventDispatcher.html">EventDispatcher</a></li>
                                <li><a href="../classes/FunctionUtils.html">FunctionUtils</a></li>
                                <li><a href="../classes/GeolocationDetection.html">GeolocationDetection</a></li>
                                <li><a href="../classes/GestureUtils.html">GestureUtils</a></li>
                                <li><a href="../classes/GoogleAnalytics.html">GoogleAnalytics</a></li>
                                <li><a href="../classes/GTM.html">GTM</a></li>
                                <li><a href="../classes/IndexedDB.html">IndexedDB</a></li>
                                <li><a href="../classes/JSONUtils.html">JSONUtils</a></li>
                                <li><a href="../classes/KTween.html">KTween</a></li>
                                <li><a href="../classes/MathUtils.html">MathUtils</a></li>
                                <li><a href="../classes/MediaDOM.html">MediaDOM</a></li>
                                <li><a href="../classes/MetaController.html">MetaController</a></li>
                                <li><a href="../classes/MouseUtils.html">MouseUtils</a></li>
                                <li><a href="../classes/MovieTrackingParser.html">MovieTrackingParser</a></li>
                                <li><a href="../classes/Navigation.html">Navigation</a></li>
                                <li><a href="../classes/NavigationContainer.html">NavigationContainer</a></li>
                                <li><a href="../classes/NavigationLoader.html">NavigationLoader</a></li>
                                <li><a href="../classes/NavigationRouter.html">NavigationRouter</a></li>
                                <li><a href="../classes/NumberUtils.html">NumberUtils</a></li>
                                <li><a href="../classes/ObjectUtils.html">ObjectUtils</a></li>
                                <li><a href="../classes/PreloadFiles.html">PreloadFiles</a></li>
                                <li><a href="../classes/Resizer.html">Resizer</a></li>
                                <li><a href="../classes/ResizeUtils.html">ResizeUtils</a></li>
                                <li><a href="../classes/ScrollNavigationController.html">ScrollNavigationController</a></li>
                                <li><a href="../classes/ScrollUtils.html">ScrollUtils</a></li>
                                <li><a href="../classes/ShareUtils.html">ShareUtils</a></li>
                                <li><a href="../classes/Shortcut.html">Shortcut</a></li>
                                <li><a href="../classes/SplitTextUtils.html">SplitTextUtils</a></li>
                                <li><a href="../classes/SpriteSheetAnimation.html">SpriteSheetAnimation</a></li>
                                <li><a href="../classes/SRTParser.html">SRTParser</a></li>
                                <li><a href="../classes/StringUtils.html">StringUtils</a></li>
                                <li><a href="../classes/SunUtils.html">SunUtils</a></li>
                                <li><a href="../classes/Tracking.html">Tracking</a></li>
                                <li><a href="../classes/URLUtils.html">URLUtils</a></li>
                                <li><a href="../classes/VideoCanvas.html">VideoCanvas</a></li>
                                <li><a href="../classes/VideoSubtitle.html">VideoSubtitle</a></li>
                                <li><a href="../classes/ViewsData.html">ViewsData</a></li>
                            </ul>
                
                
                            <ul id="api-modules" class="apis modules">
                                <li><a href="../modules/caim.html">caim</a></li>
                                <li><a href="../modules/caim.anim.html">caim.anim</a></li>
                                <li><a href="../modules/caim.data.html">caim.data</a></li>
                                <li><a href="../modules/caim.debug.html">caim.debug</a></li>
                                <li><a href="../modules/caim.event.html">caim.event</a></li>
                                <li><a href="../modules/caim.loader.html">caim.loader</a></li>
                                <li><a href="../modules/caim.media.html">caim.media</a></li>
                                <li><a href="../modules/caim.media.subtitles.html">caim.media.subtitles</a></li>
                                <li><a href="../modules/caim.media.tracking.html">caim.media.tracking</a></li>
                                <li><a href="../modules/caim.media.video.html">caim.media.video</a></li>
                                <li><a href="../modules/caim.navigation.core.html">caim.navigation.core</a></li>
                                <li><a href="../modules/caim.navigation.display.html">caim.navigation.display</a></li>
                                <li><a href="../modules/caim.navigation.types.html">caim.navigation.types</a></li>
                                <li><a href="../modules/caim.net.html">caim.net</a></li>
                                <li><a href="../modules/caim.tracking.html">caim.tracking</a></li>
                                <li><a href="../modules/caim.utils.html">caim.utils</a></li>
                                <li><a href="../modules/caim.utils.keyboard.html">caim.utils.keyboard</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: ../../source/coffee/caim/net/API.coffee</h1>

<div class="file">
    <pre class="code prettyprint linenums">
#import caim.event.EventDispatcher
#import caim.utils.Prototypes
###*
@class API
@extends EventDispatcher
@submodule caim.net
###
class API extends EventDispatcher

	@START: &#x27;apiStart&#x27;
	@COMPLETE: &#x27;apiComplete&#x27;
	@ERROR: &#x27;apiError&#x27;
	@PROGRESS: &#x27;apiProgress&#x27;
	@_interceptors: []

	@_request:()-&gt;
		if window.XMLHttpRequest then return new XMLHttpRequest()
		else if window.ActiveXObject then return new ActiveXObject(&quot;MSXML2.XMLHTTP.3.0&quot;)

	@callGet:(url, onComplete = null)-&gt;
		api = new API(url)
		if onComplete
			api.on(API.COMPLETE, onComplete)
		api.callGet()

	@call:(url, data = null, onComplete = null, onError = null, type = &#x27;normal&#x27;)-&gt;
		api = new API(url)
		if url instanceof HTMLElement &amp;&amp; url.tagName.toLowerCase() == &#x27;form&#x27;
			url.submit()
		else if BaseDOM? &amp;&amp; url instanceof BaseDOM &amp;&amp; url.element.tagName.toLowerCase == &#x27;form&#x27;
			url.submit()

		if onComplete
			api.on(API.COMPLETE, onComplete)
		if onError
			api.on(API.ERROR, onError)
		api.type = type
		api.submit(data)
		return api

	@intercept:(regexPattern, callback)-&gt;
		if !(regexPattern instanceof RegExp)
			regexPattern = new RegExp(regexPattern)
		i = @_interceptors.length
		while i-- &gt; 0
			if @_interceptors[i].regex == regexPattern &amp;&amp; @_interceptors[i].callback == callback
				return
		@_interceptors.push({regex: regexPattern, callback: callback})

	@unintercept:(regexPattern, callback = null)-&gt;
		i = @_interceptors.length
		while i-- &gt; 0
			if @_interceptors[i].regex == regexPattern &amp;&amp; (callback &amp;&amp; @_interceptors[i].callback == callback)
				@_interceptors.splice(i, 1)

	@_findInterceptor:(regexPattern, callback)-&gt;
		i = @_interceptors.length
		interceptors = []
		while i-- &gt; 0
			interceptor = @_interceptors[i]
			if interceptor.regex == regexPattern &amp;&amp; interceptor.callback == callback
				interceptors.push(interceptor)
		return interceptors
	@_checkInterceptor:(url, data)-&gt;
		l = @_interceptors.length
		i = -1
		while ++i &lt; l
			interceptor = @_interceptors[i]
			interceptor.regex.lastIndex = 0
			if interceptor.regex.test(url)
				interceptor.callback?(data, url)


	# FORM
	# URL
	# Object

	###*
	@class API
	@constructor
	@extends EventDispatcher
	###
	constructor: (arg) -&gt;
		super
		@TYPES = [&#x27;normal&#x27;, &#x27;json&#x27;]
		@_headers = []
		@_reuse = true
		@_method = &#x27;POST&#x27;
		@_jsonp = false
		@_type = &#x27;normal&#x27;
		if arg instanceof HTMLElement &amp;&amp; arg.tagName.toLowerCase() == &#x27;form&#x27;
			@_form = arg
			setTimeout(@_addEventListeners, 10)
		else if BaseDOM? &amp;&amp; arg instanceof BaseDOM &amp;&amp; arg.element.tagName.toLowerCase == &#x27;form&#x27;
			@_form = arg
			setTimeout(@_addEventListeners, 10)
		else if typeof(arg) == &#x27;string&#x27;
			@_url = arg
		else if arg?
			throw new Error(&#x27;The API constructor argument needs to be a URL string or a Form element.&#x27;)

	@get reuse:()-&gt;
		return @_reuse
	@set reuse:(value)-&gt;
		@_reuse = Boolean(value)

	@get type:()-&gt;
		return @_type

	@set type:(value)-&gt;
		if !(value in @TYPES)
			throw new Error(&#x27;API.type can only be: &#x27; + @TYPES.join(&#x27;, &#x27;))
		@_type = value

	@get method:()-&gt;
		return @_method

	@set method:(value)-&gt;
		if !/^(get|post)$/i.test(value)
			throw new Error(&#x27;Method can only be either GET or POST&#x27;)
		@_method = value.toUpperCase()

	# Not implemented yet
	@get jsonp:()-&gt;
		throw new Error(&#x27;Not implemented yet&#x27;)
		return @_jsonp
	@set jsonp:(value)-&gt;
		throw new Error(&#x27;Not implemented yet&#x27;)
		@_jsonp = Boolean(@_jsonp)

	@get data:()-&gt;
		return @_data

	@get requestURL:()-&gt;
		return @_requestURL

	_addEventListeners:()=&gt;
		if @_form
			@_form.on(&#x27;submit&#x27;, @_submitForm)

	_submitForm:(e)=&gt;
		@submit()

	addHeader:(name, value)-&gt;
		@_headers[name] = value
	removeHeader:(name)-&gt;
		@_headers[name] = null
		delete @_headers[name]

	load:(url, data = null)-&gt;
		@_url = url
		@submit(data)

	callGet:()=&gt;
		url = @_url || &#x27;&#x27;
		data = null
		@method = &#x27;GET&#x27;
		@_requestURL = url
		@_request = API._request()
		@_request.onreadystatechange = @_loaded
		@_request.open(@method, url, true)
		@trigger(API.START)
		@_request.send(data)
		return 

	submit:(data = null)=&gt;
		@_data = data
		if @_submitting
			return
		@_submitting = true

		if data instanceof HTMLElement &amp;&amp; data.tagName.toLowerCase() == &#x27;form&#x27;
			@_form = data
			data = null
		else if BaseDOM? &amp;&amp; data instanceof BaseDOM &amp;&amp; data.element.tagName.toLowerCase == &#x27;form&#x27;
			@_form = data.element
			data = null

		url = @_url || &#x27;&#x27;
		if @_form
			if @_form.hasAttribute(&#x27;action&#x27;)
				url = @_form.getAttribute(&#x27;action&#x27;)
			if @_form.hasAttribute(&#x27;enctype&#x27;)
				@addHeader(&#x27;Content-type&#x27;, @_form.getAttribute(&#x27;enctype&#x27;))
			if @_form.hasAttribute(&#x27;method&#x27;)
				@method = @_form.getAttribute(&#x27;method&#x27;)
			if @_form.hasAttribute(&#x27;type&#x27;) &amp;&amp; @_form.getAttribute(&#x27;type&#x27;) == &#x27;json&#x27;
				@addHeader(&#x27;Content-type&#x27;, &#x27;application/x-www-form-urlencoded;charset=UTF-8&#x27;)
				data = JSON.stringify(@_parseJSON(@_form))
			else
				data = new FormData(@_form)
		else

			if @_type == &#x27;normal&#x27;
				if !data
					data = new FormData()
				if data &amp;&amp; !(data instanceof FormData)
					d = new FormData();
					d.append n, v for n, v of data
					data = d
			else if @_type == &#x27;json&#x27;
				@addHeader(&#x27;Content-type&#x27;, &#x27;application/x-www-form-urlencoded;charset=UTF-8&#x27;)
				data = JSON.stringify(data)


		getValues = {}
		urlParams = window.location.search
		if urlParams
			urlParams = urlParams.replace(/^\??/, &#x27;&#x27;).split(&#x27;&amp;&#x27;)
			for up in urlParams
				parts = up.split(&#x27;=&#x27;)
				if parts[0]?.trim().length &gt; 0
					getValues[parts[0].trim()] = parts[1]?.trim()

		getStr = []
		for k, v of getValues
			getStr.push(k + &#x27;=&#x27; + v)
		getStr = getStr.join(&#x27;&amp;&#x27;)
		if getStr.length &gt; 0
			if url.indexOf(&#x27;?&#x27;) &gt;= 0
				url += &#x27;&amp;&#x27; + getStr
			else
				url += &#x27;?&#x27; + getStr
		@_requestURL = url
		@_request = API._request()
		@_request.onreadystatechange = @_loaded
		@_request.upload?.addEventListener(&#x27;progress&#x27;, @_progress)
		@_request.addEventListener(&#x27;progress&#x27;, @_progress)
		@_request.open(@method, url, true)
		if @_headers
			for k, v of @_headers
				@_request.setRequestHeader(k, v)
		if @_form &amp;&amp; @_form.getAttribute(&#x27;globalLoading&#x27;)
			@_loading = new cms.ui.Loading()
			@_loading.css({&#x27;position&#x27;: &#x27;fixed&#x27;})
			@_loading.show()
			window.addEventListener(&#x27;resize&#x27;, @_loadingResize)

			app.interface.context.appendChildAt(@_loading, 0)
			setTimeout(@_loadingResize, 0)
		@trigger(API.START)
		@_request.send(data)
		return 
		
	_hideLoading:()=&gt;
		if @_loading
			@_loading?.progress = 1
			@_loading.on(cms.ui.Loading.HIDE_COMPLETE, @_loadingHideComplete)
			@_loading.hide()

	_loadingHideComplete:()=&gt;
		# if @_loading.element.parentNode
		# 	@_loading.element.parentNode.removeChild(@_loading.element)
		@_loading.off(cms.ui.Loading.HIDE_COMPLETE, @_loadingHideComplete)
		@_loading.destroy?()
		@_loading = null
		window.removeEventListener(&#x27;resize&#x27;, @_loadingResize)
		delete @_loading


	_progress:(e)=&gt;
		if e.loaded &gt; e.total
			p = 0.5
		else
			p = e.loaded / e.total
		p *= 0.5
		if e.currentTarget != @_request.upload
			p += 0.5
		@_loading?.progress = p
		@_triggerProgress(p)

	_triggerProgress:(progress)-&gt;
		@trigger(API.PROGRESS, {loaded: progress, total: 1, progress: progress})

	_parseJSON:(form)-&gt;
		@_parsedElements = []
		result = @_parseJSONElement(form)
		return result

	_parseJSONElement:(element, indent = 0)=&gt;
		items = element.querySelectorAll(&#x27;[json-name]&#x27;)
		o = {}
		ind = &#x27;&#x27;
		i = indent
		while i-- &gt; 0
			ind += &#x27; &#x27;
		addC = 0
		for item in items
			if @_parsedElements.indexOf(item) &gt;= 0
				continue
			@_parsedElements.push(item)

			name = item.getAttribute(&#x27;json-name&#x27;)
			
			if data = @_parseJSONElement(item, indent + 2)
				if !o[name]
					o[name] = []
				o[name].push(data)
		inputs = element.querySelectorAll(&#x27;input,textarea&#x27;)
		for input in inputs
			if @_parsedElements.indexOf(input) &gt;= 0
				continue
			@_parsedElements.push(input)
			value = input.value
			if input.hasAttribute(&#x27;type&#x27;)
				switch input.getAttribute(&#x27;type&#x27;).toLowerCase()
					when &#x27;radio&#x27;, &#x27;checkbox&#x27;
						if !o[input.name]
							o[input.name] = []
						if !input.checked
							continue
			if o[input.name]
				if !Array.isArray(o[input.name])
					o[input.name] = [o[input.name]]
				o[input.name].push(value)
			else
				o[input.name] = value
		return o
	abort:-&gt;
		@_submitting = false
		if @_request
			@_request.onreadystatechange = null
			@_request.abort()
		if !@_reuse
			@off()
	_loaded:(e)=&gt;
		if e.currentTarget.readyState == 4
			@_submitting = false
			if e.currentTarget.status == 200
				@_triggerProgress(1)

				response = e.currentTarget.responseText || e.currentTarget.response || &#x27;&#x27;
				try 
					data = eval(&#x27;(&#x27; + response + &#x27;)&#x27;)
				catch e
					try
						data = JSON.stringify(response)
				if !data
					data = response
				else if typeof(data) == &#x27;string&#x27;
					data = response
				if data?.error
					return @_loadError(data)
				else
					return @_loadSuccess(data)
			else
				if e.currentTarget.status == 404
					return @_loadError({message: &#x27;&#x27;})
				else
					return @_loadError({message: &#x27;&#x27;})
			if !@_reuse
				@off()

	_loadSuccess:(data = null)-&gt;
		@_hideLoading()
		@trigger(API.COMPLETE, data)
		@constructor._checkInterceptor(@_requestURL, data)

	_loadError:(data = null)-&gt;
		@_hideLoading()
		@trigger(API.ERROR, data)
		@constructor._checkInterceptor(@_requestURL, data)
	_loadingResize:()=&gt;
		if !@_loading
			return
		bounds = app.interface.context.getBounds()
		@_loading.css({
			&#x27;top&#x27;: bounds.top + &#x27;px&#x27;
			&#x27;left&#x27;: bounds.left + &#x27;px&#x27;
			&#x27;height&#x27;: bounds.height + &#x27;px&#x27;
			&#x27;width&#x27;: bounds.width + &#x27;px&#x27;
		})

    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
